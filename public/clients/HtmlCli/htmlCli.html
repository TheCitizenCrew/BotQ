<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="mobile-web-app-capable" content="yes" />
<title>HtmlCli</title>
<link href="/js/require.css" rel="stylesheet" type="text/css" />
<style>
html, body {
	margin: 0;
	padding: 0;
	border: 0;
	font-size: 100%;
	font-weight: normal;
	background-color: black;
}
#playground {
	width: 100%;
	height: 100%;
	position: absolute;
	margin: 0;
	padding: 0;
	overflow : hidden;
}

</style>
</head>
<body>
	<div id="playground"></div>

	<script src="/js/require.js"></script>
	<script src="htmlCliCommon.js"></script>
	<script>
		"use strict";

		var worker = null;
		var messagePlaying = false ;
		var staticMediaTimer = null ;

		require([ 'jquery', 'jplayer' ], function($) {

			// debug/essai
			//displayHtmlUrl({play_duration:15000, content: 'http://botq.localhost/pages/chrono.html#msg1'});
			
			
			worker = new Worker('htmlCliWorker.js?'+(new Date()/1000));
			worker.addEventListener('message', workerOnMessage, false);
			worker.postMessage({
				cmd : 'start'
			}); // Send data to our worker.
			
		});

		/**
		 * Listen on worker's messages
		 
		 * instanceof ne fonctionne plus, après être passé dans la machine à message du WebWorker tous les objets sont de l'instance Object !
		 */
		function workerOnMessage(e) {

			console.log('htmlCli received a message: '+e.data.id);
			console.log(e);
			
			if( staticMediaTimer ){
				clearTimeout(staticMediaTimer);
				staticMediaTimer = null ;
			}

			if( messagePlaying == true )
				messagePlayDone(e.data, 'aborted');
			messagePlaying = true ;

			if( e.data.content_type.indexOf('video/') == 0) {
				displayVideo(e.data);
			} else if( e.data.content_type == 'application/url' ) {
				displayHtmlUrl(e.data);
			} else {
				console.log('ERROR: unknow message type !');
				messagePlayDone(e.data, 'error');
			}
		}

		function displayHtmlUrl(message) {

			console.log('displayHtmlUrl start for '+ message.play_duration);

			var content = JSON.parse( message.content );

			var html = '' ;

			if( content.style){
				html += '<style>'
					+'#theIframe {'
					+'/*position : absolute;'
					+'top      : 0;'
					+'left     : 0;'
					+'height   : 200px;*/'
					+'}'
					+'</style>';
			}

			html += '<iframe id="theIframe"'
				+' src="' + content.url + '"'
				+' width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" />';

				$('#playground').html(html);

			staticMediaTimer = setTimeout( displayHtmlUrlOnTimer, message.play_duration, message);
		}

		function displayHtmlUrlOnTimer( message )
		{
			console.log('displayHtmlUrl ended');
			//$(this).jPlayer("play"); // play again !
			staticMediaTimer = null ;
			messagePlayDone(message, 'done');			
		}

		function displayVideo(videomessage) {

			$('#playground')
				.html(
					'<div id="jp_container" class="jp-video " role="application" aria-label="media player">'
					+'<div class="jp-type-single">'
					+'<div id="jquery_jplayer" class="jp-jplayer">'
					+'</div></div></div>');

			var media_supplied;
			var media = {
				title : 'Some video'
			};
			switch( videomessage.content_type ){
			case 'video/mp4':
				media.m4v = videomessage.content;
				media_supplied = 'm4v';
				break;
			case 'video/ogg':
				media.ogv = videomessage.content;
				media_supplied = 'ogv';
				break;
			case 'video/webm':
				media.webmv = videomessage.content;
				media_supplied = 'webmv';
				break;
			case 'video/flv':
				media.flv = videomessage.content;
				media_supplied = 'flv';
				break;
			default:
				console.log('ERROR', 'unknow media type "' + videomessage.content_type + '"');
				messagePlayDone(videomessage, 'error');
				return;
			}
	console.log(media_supplied);
	console.log(media);
			$("#jquery_jplayer").jPlayer({
				ready : function() {
					console.log('jPlayer.ready');
					$(this).jPlayer('setMedia', media);
					$(this).jPlayer('play');
				},
				ended : function() {
					console.log('jPlayer.ended');
					//$(this).jPlayer("play"); // play again !
					messagePlayDone(videomessage, 'done');
				},
				cssSelectorAncestor : "#jp_container",
				preload : 'auto',
				supplied : media_supplied,
				solution : 'html, flash',
				size : {
					width : "" + window.innerWidth + "px",
					height : "" + window.innerHeight + "px"
				},

			});
		}

		/**
		 * to call when a message play is finished (done).
		 */
		function messagePlayDone(message, status) {

			messagePlaying = false ;

			var cmd ;
			if( status == 'done') {
				cmd = 'messageDone';
			} else if( status == 'aborted') {
				cmd = 'messageAborted';
			} else if( status == 'error') {
				cmd = 'messageError';
			}
			worker.postMessage({
				'cmd' : cmd,
				'message' : message
			}); // Send data to our worker.

		}
	</script>
</body>
</html>